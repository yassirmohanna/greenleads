// Prisma schema for Nextdoor leads

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LeadStatus {
  NEW
  CONTACTED
  WON
  LOST
  IGNORED
}

enum LeadCategory {
  LANDSCAPING
  INSTALL
  UNKNOWN
}

enum NotificationChannel {
  SMS
  EMAIL
}

enum UserRole {
  OWNER
  USER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  invitesCreated Invite[] @relation("InvitesCreated")
  invitesUsed    Invite[] @relation("InvitesUsed")
}

model Lead {
  id          String       @id @default(cuid())
  source      String
  postUrl     String       @unique
  title       String
  snippet     String
  rawSender   String
  receivedAt  DateTime
  city        String?
  category    LeadCategory @default(UNKNOWN)
  score       Int
  status      LeadStatus   @default(NEW)
  rawBody     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  notifications NotificationLog[]
}

model Settings {
  id                   Int     @id @default(1)
  keywordConfig        Json
  cityList             Json
  threshold            Int
  pollIntervalMinutes  Int
  rateLimitPerHour     Int
  storeRawEmail        Boolean @default(false)
  smsTargets           Json
  emailTargets         Json
  lastImapUid          Int?
  lastGmailQueryAfter  Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model NotificationLog {
  id        String               @id @default(cuid())
  channel   NotificationChannel
  postUrl   String
  leadId    String?
  sentAt    DateTime @default(now())
  lead      Lead?    @relation(fields: [leadId], references: [id])
}

model Invite {
  id             String   @id @default(cuid())
  token          String   @unique
  email          String?
  createdById    String?
  usedById       String?
  createdAt      DateTime @default(now())
  usedAt         DateTime?
  revokedAt      DateTime?
  createdBy      User?    @relation("InvitesCreated", fields: [createdById], references: [id])
  usedBy         User?    @relation("InvitesUsed", fields: [usedById], references: [id])
}
